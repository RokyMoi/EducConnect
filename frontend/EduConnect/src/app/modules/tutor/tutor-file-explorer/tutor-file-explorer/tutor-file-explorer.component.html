<div class="main-container">
    <h2>My Uploaded Files</h2>
    <div class="note-banner" *ngIf="showAutoGeneratedNote">
        <i class="fas fa-info-circle"></i>
        <span>Files marked with <span class="asterisk">*</span> are autogenerated and cannot be modified</span>
    </div>
    <div class="action-buttons-container">
        <button class="go-back-button" (click)="goBack()">‚Üê Go Back</button>
    </div>

    <div class="files-container" *ngIf="allFilesUploadedByPerson.length > 0; else noFiles">
        <table class="files-table desktop-view">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Description</th>
                    <th>File Name</th>
                    <th (click)="sort('size')" class="sortable">Size<i class="sort-icon" [ngClass]="{
                        'fas fa-sort-up': sortColumn === 'size' && sortDirection === 'asc',
                        'fas fa-sort-down': sortColumn === 'size' && sortDirection === 'desc'
                      }"></i></th>
                    <th (click)="sort('type')" class="sortable">Type <i class="sort-icon" [ngClass]="{
                        'fas fa-sort-up': sortColumn === 'type' && sortDirection === 'asc',
                        'fas fa-sort-down': sortColumn === 'type' && sortDirection === 'desc'
                      }"></i></th>
                    <th (click)="sort('uploadDate')" class="sortable">
                        Upload Date
                        <i class="sort-icon" [ngClass]="{
                          'fas fa-sort-up': sortColumn === 'uploadDate' && sortDirection === 'asc',
                          'fas fa-sort-down': sortColumn === 'uploadDate' && sortDirection === 'desc'
                        }"></i>
                    </th>

                    <th (click)="sort('lastUpdated')" class="sortable">
                        Last Updated
                        <i class="sort-icon" [ngClass]="{
                          'fas fa-sort-up': sortColumn === 'lastUpdated' && sortDirection === 'asc',
                          'fas fa-sort-down': sortColumn === 'lastUpdated' && sortDirection === 'desc'
                        }"></i>
                    </th>
                    <th class="actions-header">Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr *ngFor="let file of allFilesUploadedByPerson">
                    <td *ngIf="selectedFileForEdit?.id !== file.id">
                        {{ file.title }}
                        <span class="autogenerated-indicator" *ngIf="!isEditable(file)">*</span>
                    </td>
                    <td *ngIf="selectedFileForEdit?.id === file.id && selectedFileForEdit"><input type="text"
                            [(ngModel)]="selectedFileForEdit.title" #titleInput="ngModel" required minlength="1"
                            maxlength="100" class="edit-input"
                            [class.invalid]="titleInput.invalid && (titleInput.dirty || titleInput.touched)">
                        <div *ngIf="titleInput.invalid && (titleInput.dirty || titleInput.touched)"
                            class="error-message">
                            <div *ngIf="titleInput.errors?.['required']">Title is required</div>
                            <div *ngIf="titleInput.errors?.['minlength']">Title must be at least 1 character</div>
                            <div *ngIf="titleInput.errors?.['maxlength']">Title cannot exceed 100 characters</div>
                        </div>
                    </td>
                    <td *ngIf="selectedFileForEdit?.id !== file.id">{{ file.description || '-' }}</td>
                    <td *ngIf="selectedFileForEdit?.id === file.id && selectedFileForEdit"><textarea
                            [(ngModel)]="selectedFileForEdit.description" #descInput="ngModel" required minlength="25"
                            maxlength="255" class="edit-input"
                            [class.invalid]="descInput.invalid && (descInput.dirty || descInput.touched)"></textarea>
                        <div *ngIf="descInput.invalid && (descInput.dirty || descInput.touched)" class="error-message">
                            <div *ngIf="descInput.errors?.['required']">Description is required</div>
                            <div *ngIf="descInput.errors?.['minlength']">Description must be at least 25 characters
                            </div>
                            <div *ngIf="descInput.errors?.['maxlength']">Description cannot exceed 255 characters</div>
                        </div>
                    </td>
                    <td class="file-name" [title]="file.fileName">{{
                        file.fileName }}</td>
                    <td>{{ file.fileSize | fileSize }}</td>
                    <td>{{ file.contentType }}</td>
                    <td>{{ file.createdAt | date:'mediumDate' }}</td>
                    <td>{{ (file.updatedAt | date:'mediumDate') || '-' }}</td>
                    <td class="actions-cell">

                        <ng-container class="action-buttons"
                            *ngIf="selectedFileForEdit?.id !== file.id; else editControl">



                            <button class="action-button view-button" (click)="onOpenFile(file.source)">
                                <i class="fas fa-eye"></i>
                                <span class="button-text">Open</span>
                            </button>
                            <button class="action-button download-button" (click)="onDownloadFile(file)">
                                <i class="fas fa-download"></i>
                                <span class="button-text">Download</span>
                            </button>
                            <button class="action-button edit-button" [disabled]="!isEditable(file)"
                                [title]="!isEditable(file) ? 'This file type cannot be edited' : ''"
                                (click)="startEdit(file)">
                                <i class="fas fa-edit"></i>
                                <span class="button-text">Edit</span>
                            </button>
                            <button class="action-button delete-button" (click)="onDeleteFile(file)">
                                <i class="fas fa-trash-can"></i>
                                <span class="button-text">Delete</span>
                            </button>
                        </ng-container>
                        <ng-template #editControl class="action-buttons">
                            <button class="action-button save-button" (click)="saveEdit()"><i
                                    class="fas fa-check"></i>Save</button>
                            <button class="action-button discard-button" (click)="cancelEdit()"><i
                                    class="fas fa-rotate-left"></i>Undo</button>
                        </ng-template>

                    </td>
                </tr>
            </tbody>
        </table>
        <div class="mobile-view">
            <div class="file-tile" *ngFor="let file of allFilesUploadedByPerson">
                <div class="tile-section">
                    <span class="tile-label">Title:</span>
                    <span class="tile-value" *ngIf="selectedFileForEdit?.id !== file.id">
                        {{ file.title }}
                        <span class="autogenerated-indicator" *ngIf="!isEditable(file)">*</span>
                    </span>
                    <span class="tile-value" *ngIf="selectedFileForEdit?.id === file.id && selectedFileForEdit">
                        <input type="text" [(ngModel)]="selectedFileForEdit.title" #titleInput="ngModel" required
                            minlength="1" maxlength="100" class="edit-input"
                            [class.invalid]="titleInput.invalid && (titleInput.dirty || titleInput.touched)">
                        <div *ngIf="titleInput.invalid && (titleInput.dirty || titleInput.touched)"
                            class="error-message">
                            <div *ngIf="titleInput.errors?.['required']">Title is required</div>
                            <div *ngIf="titleInput.errors?.['minlength']">Title must be at least 1 character</div>
                            <div *ngIf="titleInput.errors?.['maxlength']">Title cannot exceed 100 characters</div>
                        </div>
                    </span>
                </div>
                <div class="tile-section">
                    <span class="tile-label">Description:</span>
                    <span class="tile-value" *ngIf="selectedFileForEdit?.id !== file.id">{{ file.description || '-'
                        }}</span>
                    <span class="tile-value"
                        *ngIf="selectedFileForEdit?.id === file.id && selectedFileForEdit"><textarea
                            [(ngModel)]="selectedFileForEdit.description" #descInput="ngModel" required minlength="25"
                            maxlength="255" class="edit-input"
                            [class.invalid]="descInput.invalid && (descInput.dirty || descInput.touched)"></textarea>
                        <div *ngIf="descInput.invalid && (descInput.dirty || descInput.touched)" class="error-message">
                            <div *ngIf="descInput.errors?.['required']">Description is required</div>
                            <div *ngIf="descInput.errors?.['minlength']">Description must be at least 25 characters
                            </div>
                            <div *ngIf="descInput.errors?.['maxlength']">Description cannot exceed 255 characters</div>
                        </div>

                    </span>
                </div>
                <div class="tile-section">
                    <span class="tile-label">File Name:</span>
                    <span class="tile-value" [title]="file.fileName">{{ file.fileName }}</span>
                </div>
                <div class="tile-section">
                    <span class="tile-label">Size:</span>
                    <span class="tile-value">{{ file.fileSize | fileSize }}</span>
                </div>
                <div class="tile-section">
                    <span class="tile-label">Type:</span>
                    <span class="tile-value">{{ file.contentType }}</span>
                </div>
                <div class="tile-section">
                    <span class="tile-label">Upload Date:</span>
                    <span class="tile-value">{{ file.createdAt | date:'mediumDate' }}</span>
                </div>
                <div class="tile-section">
                    <span class="tile-label">Last Updated:</span>
                    <span class="tile-value">{{ (file.updatedAt | date:'mediumDate') || '-' }}</span>
                </div>
                <div class="action-buttons">

                    <ng-container class="action-buttons" *ngIf="selectedFileForEdit?.id !== file.id; else editControl">


                        <button class="action-button view-button" (click)="onOpenFile(file.source)">
                            <i class="fas fa-eye"></i>
                            <span class="button-text">Open</span>
                        </button>
                        <button class="action-button download-button" (click)="onDownloadFile(file)">
                            <i class="fas fa-download"></i>
                            <span class="button-text">Download</span>
                        </button>
                        <button class="action-button edit-button" [disabled]="!isEditable(file)"
                            [title]="!isEditable(file) ? 'This file type cannot be edited' : ''"
                            (click)="startEdit(file)">
                            <i class="fas fa-edit"></i>
                            <span class="button-text">Edit</span>
                        </button>
                        <button class="action-button delete-button" (click)="onDeleteFile(file)">
                            <i class="fas fa-trash-can"></i>
                            <span class="button-text">Delete</span>
                        </button>
                    </ng-container>
                </div>
                <ng-template #editControl class="action-buttons">
                    <button class="action-button save-button" (click)="saveEdit()"><i
                            class="fas fa-check"></i>Save</button>
                    <button class="action-button discard-button" (click)="cancelEdit()"><i
                            class="fas fa-rotate-left"></i>Undo</button>
                </ng-template>
            </div>
        </div>
    </div>

    <ng-template #noFiles>
        <div class="no-files-message">
            No files uploaded yet.
        </div>
    </ng-template>
    <app-custom-header-ng-content-dialog-box *ngIf="showDeleteDialog" [title]="'Delete File'">
        <p>{{deleteDialogMessage}}</p>
        <div class="dialog-actions">
            <button class="cancel-button" (click)="onCancelDeleteDialog()">Cancel</button>
            <button class="confirm-button" (click)="deleteFile()">Confirm</button>
        </div>
    </app-custom-header-ng-content-dialog-box>
</div>